docker compose down -v --remove-orphans && docker compose build --no-cache && docker compose up

docker-compose down -v --remove-orphans && docker-compose build --no-cache && docker-compose up

docker compose down -v --remove-orphans

docker compose build --no-cache

docker compose up -d

# –î–ª—è –≤—Å–µ—Ö
curl http://localhost:8080/api/sources

curl http://localhost:8080/api/sources/5

curl -X POST http://localhost:8080/api/sources -H "Content-Type: application/json" -d '{"name":"Test item", "address":"124.125"}'

curl -X PUT http://localhost:8080/api/sources/5 -H "Content-Type: application/json" -d '{"name":"Updated Name", "address":"Dada da"}'

curl -X DELETE http://localhost:8080/api/sources/5

# –î–ª—è post_tags
curl http://localhost:8080/api/post_tags/1/3

curl -X DELETE http://localhost:8080/api/post_tags/1/3


# –í–æ–π—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä PostgreSQL –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å psql
docker exec -it postgres-master psql -U news_user -d news_db

# –ü–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL –≤—ã–ø–æ–ª–Ω–∏:
\l                     # –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö
\dt                    # –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
\d+ sources            # –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã sources
\d+ posts              # –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã posts
\d+ users              # –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã users
\d+ authors            # –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã authors

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
SELECT * FROM sources LIMIT 10;
SELECT COUNT(*) FROM sources;
SELECT * FROM posts LIMIT 5;
SELECT * FROM authors LIMIT 5;
SELECT table_name, table_rows FROM information_schema.tables WHERE table_schema = 'public';

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é (–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ —Ä–µ–ø–ª–∏–∫–∏)
docker exec -it postgres-replica psql -U news_user -d news_db -c "SELECT pg_is_in_recovery();"
docker exec -it postgres-replica psql -U news_user -d news_db -c "SELECT * FROM pg_stat_wal_receiver;"


SELECT 'sources' as table, COUNT(*) as count FROM sources
UNION ALL
SELECT 'authors', COUNT(*) FROM authors
UNION ALL
SELECT 'posts', COUNT(*) FROM posts
UNION ALL
SELECT 'users', COUNT(*) FROM users
UNION ALL
SELECT 'tags', COUNT(*) FROM tags
UNION ALL
SELECT 'channels', COUNT(*) FROM channels
UNION ALL
SELECT 'comments', COUNT(*) FROM comments
UNION ALL
SELECT 'media', COUNT(*) FROM media
UNION ALL
SELECT 'news_texts', COUNT(*) FROM news_texts;


SELECT 
    c.channel_id,
    c.name AS channel_name,
    c.link,
    c.subscribers_count,
    s.name AS source_name
FROM channels c
LEFT JOIN sources s ON c.source_id = s.source_id;




docker exec -it mongodb mongosh -u news_app -p app_password news_aggregator
show collections;
db.posts.countDocuments();
db.posts.find().limit(3).pretty();


docker exec -it mongodb mongosh
use news_aggregator
db.auth("news_app", "app_password")
print("\n" + "=".repeat(80));

print("\n" + "=".repeat(80));
print("CURRENT PERFORMANCE TEST - AFTER OPTIMIZATIONS");
print("=".repeat(80));

print("\n1. –¢–ï–°–¢: GetUserHistory (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)");
print("-".repeat(40));

var testUsers = ["user_1", "user_10", "user_100"];
testUsers.forEach(function(user) {
  var start = Date.now();
  
  // –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –í–ï–†–°–ò–Ø: —Å–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
  var pipeline1 = [
    { $match: { user_id: user } },
    { $sort: { timestamp: -1 } },
    { $limit: 50 },
    { $project: { action: 1, timestamp: 1, post_id: 1, _id: 0 } }
  ];
  
  var interactions = db.user_interactions.aggregate(pipeline1).toArray();
  
  // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å—Ç—ã –æ—Ç–¥–µ–ª—å–Ω—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
  if (interactions.length > 0) {
    var postIDs = interactions.map(function(inter) { return inter.post_id; });
    var posts = db.posts.find(
      { post_id: { $in: postIDs } },
      { projection: { post_id: 1, title: 1 } }
    ).toArray();
  }
  
  print("   User '" + user + "': " + (Date.now() - start) + "ms, " + 
        interactions.length + " interactions");
});

print("\n2. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: GetUserHistory (—Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è)");
print("-".repeat(40));

testUsers.forEach(function(user) {
  var start = Date.now();
  
  // –°–¢–ê–†–ê–Ø –í–ï–†–°–ò–Ø: –æ–¥–∏–Ω —Å–ª–æ–∂–Ω—ã–π pipeline
  var pipeline = [
    { $match: { user_id: user } },
    { $lookup: {
      from: "posts",
      localField: "post_id",
      foreignField: "post_id",
      as: "post_details"
    }},
    { $unwind: "$post_details" },
    { $sort: { timestamp: -1 } },
    { $limit: 50 },
    { $project: {
      action: 1,
      timestamp: 1,
      post_id: 1,
      post_title: "$post_details.title",
      _id: 0
    }}
  ];
  
  var result = db.user_interactions.aggregate(pipeline).toArray();
  print("   User '" + user + "': " + (Date.now() - start) + "ms, " + 
        result.length + " interactions");
});

print("\n3. –¢–ï–°–¢: MaterializeTopPostsView (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)");
print("-".repeat(40));

var start = Date.now();
var cutoffDate = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);

// –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
var pipeline = [
  { $match: {
    created_at: { $gte: cutoffDate },
    "stats.views": { $gt: 0 } // –¢–æ–ª—å–∫–æ –ø–æ—Å—Ç—ã —Å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞–º–∏
  }},
  { $addFields: {
    total_score: {
      $add: [
        { $multiply: ["$stats.likes", 3] },
        { $multiply: ["$stats.comments", 2] },
        { $multiply: ["$stats.views", 0.5] }
      ]
    }
  }},
  { $sort: { total_score: -1 } },
  { $limit: 100 }
];

var result = db.posts.aggregate(pipeline).toArray();
print("   Time: " + (Date.now() - start) + "ms");
print("   Posts processed: " + result.length);

print("\n4. –¢–ï–°–¢: AdvancedSearch (—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∏–Ω–¥–µ–∫—Å–æ–≤)");
print("-".repeat(40));

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ –∏–Ω–¥–µ–∫—Å—ã
var testFilter = { tags: "–Ω–æ–≤–æ—Å—Ç–∏", "stats.likes": { $gte: 10 } };
var explainResult = db.posts.find(testFilter).limit(20).explain("executionStats");

print("   Query Plan: " + explainResult.queryPlanner.winningPlan.inputStage.stage);
print("   Index used: " + (explainResult.queryPlanner.winningPlan.inputStage.indexName || "none"));
print("   Docs examined: " + explainResult.executionStats.totalDocsExamined);
print("   Time: " + explainResult.executionStats.executionTimeMillis + "ms");

print("\n5. –¢–ï–°–¢: GetTopTags —Å allowDiskUse");
print("-".repeat(40));

var limits = [5, 10, 20, 50];
limits.forEach(function(limit) {
  var start = Date.now();
  var pipeline = [
    { $unwind: "$tags" },
    { $group: {
      _id: "$tags",
      count: { $sum: 1 },
      total_likes: { $sum: "$stats.likes" }
    }},
    { $sort: { count: -1 } },
    { $limit: limit }
  ];
  
  // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å allowDiskUse
  var cursor = db.posts.aggregate(pipeline, { allowDiskUse: true });
  cursor.toArray();
  
  print("   Limit " + limit + ": " + (Date.now() - start) + "ms");
});

print("\n" + "=".repeat(80));
print("–°–†–ê–í–ù–ï–ù–ò–ï –° –ü–†–ï–î–´–î–£–©–ò–ú–ò –†–ï–ó–£–õ–¨–¢–ê–¢–ê–ú–ò");
print("=".repeat(80));

print("\nüìä GetUserHistory (user_1):");
print("   –ë—ã–ª–æ (–¥–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏): 23ms");
print("   –°—Ç–∞–ª–æ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è): ?ms");
print("   –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è (–¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è): ?ms");

print("\nüìä MaterializeTopPostsView:");
print("   –ë—ã–ª–æ (–¥–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏): 572ms");
print("   –°—Ç–∞–ª–æ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è): ?ms");

print("\nüìä GetTopTags (limit=50):");
print("   –ë—ã–ª–æ (–¥–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏): 12ms");
print("   –°—Ç–∞–ª–æ (with allowDiskUse): ?ms");

print("\n" + "=".repeat(80));
print("–†–ï–ó–Æ–ú–ï –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ô");
print("=".repeat(80));

print("\n‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:");
print("   1. GetUserHistory: –ó–∞–º–µ–Ω–∞ lookup+unwind –Ω–∞ 2 –∑–∞–ø—Ä–æ—Å–∞");
print("   2. MaterializeTopPostsView: –î–æ–±–∞–≤–ª–µ–Ω —Ñ–∏–ª—å—Ç—Ä –ø–æ views > 0");
print("   3. GetTopTags: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω allowDiskUse –¥–ª—è –±–æ–ª—å—à–∏—Ö –∞–≥—Ä–µ–≥–∞—Ü–∏–π");
print("   4. AdvancedSearch: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –∏ batchSize");

print("\nüìà –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:");
print("   ‚Ä¢ GetUserHistory: -70% –≤—Ä–µ–º–µ–Ω–∏ (23ms ‚Üí ~7ms)");
print("   ‚Ä¢ MaterializeTopPostsView: -60% –≤—Ä–µ–º–µ–Ω–∏ (572ms ‚Üí ~230ms)");
print("   ‚Ä¢ –ë–æ–ª—å—à–∏–µ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏: –ë–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞");