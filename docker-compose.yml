services:
  db-master:
    image: postgres:15
    container_name: postgres-master
    environment:
      POSTGRES_USER: news_user
      POSTGRES_PASSWORD: news_pass
      POSTGRES_DB: news_db
    ports:
      - "5432:5432"
    volumes:
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - ./db/tmp.sql:/docker-entrypoint-initdb.d/tmp.sql:ro
      - ./db/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
      - postgres_master_data:/var/lib/postgresql/data
    command: |
      postgres
      -c wal_level=replica
      -c max_wal_senders=10
      -c max_replication_slots=10
      -c hot_standby=on
      -c hba_file=/etc/postgresql/pg_hba.conf
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U news_user -d news_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  db-replica:
    image: postgres:15
    container_name: postgres-replica
    environment:
      POSTGRES_USER: news_user
      POSTGRES_PASSWORD: news_pass
      POSTGRES_DB: news_db
    ports:
      - "5434:5432"
    volumes:
      - postgres_replica_data:/var/lib/postgresql/data
      - ./db/init-replica.sh:/docker-entrypoint-initdb.d/init-replica.sh:ro
    depends_on:
      db-master:
        condition: service_healthy
    command: |
      postgres
      -c hot_standby=on
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U news_user -d news_db"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s

  # генерация ключа для mongodb
  mongo-init:
    image: mongo:latest
    # profiles: ["init"]
    volumes:
      - mongo-keyfile:/opt/mongo-config
    command: >
      sh -c "
      openssl rand -base64 756 > /opt/mongo-config/keyfile &&
      chmod 600 /opt/mongo-config/keyfile &&
      chown 999:999 /opt/mongo-config/keyfile &&
      echo '✅ Keyfile generated' &&
      cat /opt/mongo-config/keyfile | base64
      "

  mongodb:
    image: mongo:7
    container_name: mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: mongopass
      MONGO_INITDB_DATABASE: news_aggregator
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - mongo-keyfile:/opt/mongo-config
      - ./db/mongo-init-replica-set.js:/docker-entrypoint-initdb.d/init-replica-set.js:ro
    command: 
      - bash
      - -c
      - |
        # Установить правильные права на файл ключа
        # chmod 600 /opt/mongo-config/keyfile
        # chown 999:999 /opt/mongo-config/keyfile
        exec mongod --auth --bind_ip_all --replSet rs0 --keyFile /opt/mongo-config/keyfile
        # Подождать пока MongoDB запустится
        sleep 10
        
        # Инициализировать реплика-сет
        echo "Initializing replica set..."
        mongosh --username admin --password mongopass --file /docker-entrypoint-initdb.d/init-replica-set.js
    depends_on:
      mongo-init:
        condition: service_completed_successfully
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/admin --quiet --username admin --password mongopass
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s

  mongodb-secondary-1:
    image: mongo:7
    container_name: mongodb-secondary-1
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: mongopass
    ports:
      - "27018:27017"
    volumes:
      - mongodb_secondary1_data:/data/db
      - mongo-keyfile:/opt/mongo-config
    command: 
      - bash
      - -c
      - |
        # Установить правильные права на файл ключа
        chmod 600 /opt/mongo-config/keyfile
        chown 999:999 /opt/mongo-config/keyfile
        exec mongod --auth --bind_ip_all --replSet rs0 --keyFile /opt/mongo-config/keyfile
    depends_on:
      - mongodb
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/admin --quiet --username admin --password mongopass
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s

  mongodb-secondary-2:
    image: mongo:7
    container_name: mongodb-secondary-2
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: mongopass
    ports:
      - "27019:27017"
    volumes:
      - mongodb_secondary2_data:/data/db
      - mongo-keyfile:/opt/mongo-config
    command: 
      - bash
      - -c
      - |
        # Установить правильные права на файл ключа
        chmod 600 /opt/mongo-config/keyfile
        chown 999:999 /opt/mongo-config/keyfile
        exec mongod --auth --bind_ip_all --replSet rs0 --keyFile /opt/mongo-config/keyfile
    depends_on:
      - mongodb
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/admin --quiet --username admin --password mongopass
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s

  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --save 60 1 --loglevel warning
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Go сервер вместо C++
  server:
    build:
      context: ./server-go
      dockerfile: Dockerfile
    container_name: news-aggregator-server
    depends_on:
      redis:
        condition: service_healthy
      db-master:
        condition: service_healthy
      db-replica:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    environment:
      - MONGODB_URI=mongodb://news_app:app_password@mongodb:27017/news_aggregator?authSource=news_aggregator
      - POSTGRES_MASTER=host=db-master port=5432 dbname=news_db user=news_user password=news_pass sslmode=disable
      - POSTGRES_REPLICA=host=db-replica port=5432 dbname=news_db user=news_user password=news_pass sslmode=disable
      - REDIS_ADDR=redis:6379
    ports:
      - "8080:8080"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Опционально: researcher-vk
  # researcher-vk:
  #   build:
  #     context: .
  #     dockerfile: ./researchers/vk/Dockerfile
  #   container_name: vk-researcher
  #   depends_on:
  #     server:
  #       condition: service_healthy
  #   volumes:
  #     - ./config/researchers.xml:/usr/local/etc/vk-researcher/test_conf.xml
  #     - ./researchers/vk/access_token:/usr/local/etc/vk-researcher/access_token
  #   restart: unless-stopped

  # researcher-reddit:
  #   build:
  #     context: .
  #     dockerfile: ./researchers/reddit/Dockerfile
  #   depends_on:
  #     server:
  #       condition: service_started
  #   volumes:
  #     - ./config/researchers.xml:/usr/local/etc/reddit-researcher/test_conf.xml
  #     - ./researchers/reddit/access_data:/usr/local/etc/reddit-researcher/access_data
  #     - ./researchers/reddit/token_cache.json:/usr/local/etc/reddit-researcher/token_cache.json
  #
  # data-generator:
  #   build:
  #     context: ./data-generator
  #     dockerfile: Dockerfile
  #   container_name: data-generator
  #   depends_on:
  #     server:
  #       condition: service_healthy
  #   environment:
  #     - API_URL=http://server:8080
  #     - BATCH_SIZE=3
  #     - DELAY_BETWEEN_RUNS=45
  #     - MAX_CYCLES=0
  #     - LOG_LEVEL=info
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD", "wget", "--spider", "-q", "http://server:8080/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  
  # Backup сервис
  backup:
    build:
      context: ./backups
      dockerfile: Dockerfile
    container_name: postgres-backup
    environment:
      POSTGRES_USER: news_user
      POSTGRES_PASSWORD: news_pass
    volumes:
      - ./backups:/backups
      - ./db:/db:ro
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      db-master:
        condition: service_healthy
      db-replica:
        condition: service_healthy
    restart: unless-stopped

volumes:
  postgres_master_data:
    driver: local
  postgres_replica_data:
    driver: local
  mongodb_data:
    driver: local
  redis_data:
    driver: local
  
  mongo-keyfile:

  # репликация
  mongodb_secondary1_data:
  mongodb_secondary2_data:
  # репликация -------------------
